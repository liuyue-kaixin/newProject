{"version":3,"sources":["file:///Volumes/SSD%201/ccProject/assets/script/battle/demos/bulletHell/gun.ts"],"names":["Component","Node","Prefab","Quat","Vec3","_decorator","Bullet","BulletHell","ccclass","property","tempPos","tempRot","Gun","minDist","nextCycle","isShoot","direction","shoot","targetWorldPos","subtract","node","worldPosition","lengthSqr","set","update","dt","cycleTime","parent","inst","bullets","bullet","get","insert","init","point","setPosition","dir","normalize","angle","Math","atan2","y","x","rotateZ","IDENTITY","setRotation","velocity","multiplyScalar","speed","lifeTime","rotation"],"mappings":"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","sourcesContent":["import { Component, Node, Prefab, Quat, Vec3, _decorator } from 'cc';\nimport { Bullet } from './bullet';\nimport { BulletHell } from './bulletHell';\nconst { ccclass, property } = _decorator;\n\nconst tempPos = new Vec3();\nconst tempRot = new Quat();\n\n@ccclass('Gun')\nexport class Gun extends Component {\n\n    @property(Prefab)\n    bullet: Prefab = null!;\n\n    @property(Node)\n    point: Node = null!;  //子弹射锚点\n\n    @property\n    speed: number = 1.0; //子弹飞行最大速度\n\n    @property\n    lifeTime: number = 0.5; //子弹飞行最长时间\n\n    @property\n    cycleTime: number = 0.5; //子弹发射间隔\n\n\n    minDist: number = 0;  //最近发射位置\n    nextCycle: number = 0; //下次发射时间\n    isShoot: boolean = false; //是否上弹\n    direction: Vec3 = new Vec3; //发射方向 \n\n\n    shoot(targetWorldPos: Vec3) {\n\n        //是否可以上弹\n        if (this.nextCycle > 0) return;\n\n        Vec3.subtract(tempPos, targetWorldPos, this.node.worldPosition);\n\n        //计算与怪的距离\n        let lengthSqr = tempPos.lengthSqr();\n        if (!this.isShoot) {\n            //首次上弹记录\n            this.isShoot = true;\n            this.minDist = lengthSqr;\n            this.direction.set(tempPos);\n            return;\n        }\n\n        //保留最近的怪\n        if (lengthSqr < this.minDist) {\n            this.minDist = lengthSqr;\n            this.direction.set(tempPos);\n        }\n\n    }\n\n    update(dt: number): void {\n\n        this.nextCycle -= dt;\n        if (this.isShoot) {\n            this.isShoot = false;\n            this.nextCycle = this.cycleTime;\n            \n\n            let parent = BulletHell.inst.bullets;\n            let bullet = Bullet.get(this.bullet);\n            bullet?.insert(parent); //添加到显示父节点\n            bullet?.init();\n\n            //parent.getComponent(UITransform).convertToNodeSpaceAR(this.point.worldPosition,tempPos);\n            //枪管挂点世界坐标和子弹父亲节点世界坐标的偏移坐标，就是实际当前的子坐标，其实和上面转换是等价的\n            Vec3.subtract(tempPos, this.point.worldPosition, parent.worldPosition);\n            bullet?.setPosition(tempPos);//计算发射的起点\n\n            //计算发射角度\n            let dir = this.direction.normalize();\n            let angle = Math.atan2(dir.y, dir.x);\n            Quat.rotateZ(tempRot, Quat.IDENTITY, angle);\n            bullet?.setRotation(tempRot);\n\n\n            //发射速度和生命时长\n            bullet?.velocity.set(dir).multiplyScalar(this.speed);\n            bullet!.lifeTime = this.lifeTime;\n\n\n            //调整枪管瞄准方向\n            this.node.rotation = tempRot;\n\n        }\n    }\n\n}\n\n"]}