{"version":3,"sources":["file:///Volumes/SSD%201/ccProject/extensions/oops-plugin-framework/assets/libs/animator-move/MoveTo.ts"],"names":["Component","Node","Vec3","_decorator","Timer","Vec3Util","ccclass","property","MoveTo","target","velocity","zero","speed","hasYAxis","ns","NodeSpace","LOCAL","offset","offsetVector","onStart","onComplete","onChange","timer","end","update","dt","console","assert","WORLD","worldPosition","position","exit","strictEquals","clone","add","y","start","node","sub","normalize","distance","call","step","trans","mul","destroy"],"mappings":"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","sourcesContent":["\r\n/*\r\n * @Author: dgflash\r\n * @Date: 2022-03-25 18:12:10\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2023-01-19 14:59:50\r\n */\r\nimport { Component, Node, Vec3, _decorator } from \"cc\";\r\nimport { Timer } from \"../../core/common/timer/Timer\";\r\nimport { Vec3Util } from \"../../core/utils/Vec3Util\";\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n/** 移动到指定目标位置 */\r\n@ccclass('MoveTo')\r\nexport class MoveTo extends Component {\r\n    /** 目标位置 */\r\n    target: Vec3 | Node | null = null;\r\n    /** 移动方向 */\r\n    velocity: Vec3 = Vec3Util.zero;\r\n    /** 移动速度（每秒移动的像素距离） */\r\n    speed: number = 0;\r\n    /** 是否计算将 Y 轴带入计算 */\r\n    hasYAxis: boolean = true;\r\n\r\n    /** 坐标标（默认本地坐标） */\r\n    ns: number = Node.NodeSpace.LOCAL;\r\n    /** 偏移距离 */\r\n    offset: number = 0;\r\n    /** 偏移向量 */\r\n    offsetVector: Vec3 | null = null;\r\n    /** 移动开始 */\r\n    onStart: Function | null = null;\r\n    /** 移动完成回调 */\r\n    onComplete: Function | null = null;\r\n    /** 距离变化时 */\r\n    onChange: Function | null = null;\r\n\r\n    /** 延时触发器 */\r\n    private timer: Timer = new Timer();\r\n    /** 终点备份 */\r\n    private end: Vec3 | null = null;\r\n\r\n    update(dt: number) {\r\n        let end: Vec3;\r\n\r\n        console.assert(this.speed > 0, \"移动速度必须要大于零\");\r\n\r\n        if (this.target instanceof Node) {\r\n            end = this.ns == Node.NodeSpace.WORLD ? this.target.worldPosition : this.target.position;\r\n        }\r\n        else {\r\n            end = this.target as Vec3;\r\n        }\r\n\r\n        // 移动目标节点被释放时\r\n        if (end == null) {\r\n            this.exit();\r\n            return;\r\n        }\r\n\r\n        // 目标移动后，重计算移动方向与移动到目标点的速度\r\n        if (this.end == null || !this.end.strictEquals(end)) {\r\n            let target = end.clone();\r\n            if (this.offsetVector) {\r\n                target = target.add(this.offsetVector);\r\n            }\r\n\r\n            if (this.hasYAxis == false) target.y = 0;\r\n\r\n            // 移动方向与移动数度\r\n            let start = this.ns == Node.NodeSpace.WORLD ? this.node.worldPosition : this.node.position;\r\n            this.velocity = Vec3Util.sub(target, start).normalize();\r\n\r\n            // 移动时间与目标偏位置计算\r\n            let distance = Vec3.distance(start, target) - this.offset;\r\n\r\n            // 目标位置修改事件\r\n            this.onChange?.call(this);\r\n\r\n            if (distance <= 0) {\r\n                this.exit();\r\n                return;\r\n            }\r\n            else {\r\n                this.onStart?.call(this);\r\n                this.timer.step = distance / this.speed;\r\n                this.end = end.clone();\r\n            }\r\n        }\r\n\r\n        if (this.speed > 0) {\r\n            let trans = Vec3Util.mul(this.velocity, this.speed * dt);\r\n            if (this.ns == Node.NodeSpace.WORLD)\r\n                this.node.worldPosition = Vec3Util.add(this.node.worldPosition, trans);\r\n            else\r\n                this.node.position = Vec3Util.add(this.node.position, trans);\r\n        }\r\n\r\n        // 移动完成事件\r\n        if (this.timer.update(dt)) {\r\n            if (this.offset == 0) {\r\n                if (this.ns == Node.NodeSpace.WORLD)\r\n                    this.node.worldPosition = this.end;\r\n                else\r\n                    this.node.position = this.end;\r\n            }\r\n            this.exit();\r\n        }\r\n    }\r\n\r\n    private exit() {\r\n        this.onComplete?.call(this);\r\n        this.destroy();\r\n    }\r\n}"]}