{"version":3,"sources":["file:///Volumes/%E5%9B%BA%E6%80%81/ccProject/extensions/oops-plugin-framework/assets/libs/ecs/ECSGroup.ts"],"names":["ECSGroup","matchEntities","_entitiesCache","Array","from","_matchEntities","values","entity","constructor","matcher","Map","count","_enteredEntities","_removedEntities","onComponentAddOrRemove","isMatch","set","eid","delete","has","watchEntityEnterAndRemove","enteredEntities","removedEntities","clear"],"mappings":";;;8BASaA,Q;;;;;;;;;;;;;;;;;;;;;;AATb;AACA;AACA;AACA;AACA;AACA;;;0BAIaA,Q,GAAN,MAAMA,QAAN,CAAgD;AAQnD;AACJ;AACA;AACqB,YAAbC,aAAa,GAAG;AAChB,cAAI,KAAKC,cAAL,KAAwB,IAA5B,EAAkC;AAC9B,iBAAKA,cAAL,GAAsBC,KAAK,CAACC,IAAN,CAAW,KAAKC,cAAL,CAAoBC,MAApB,EAAX,CAAtB;AACH;;AACD,iBAAO,KAAKJ,cAAZ;AACH;AAED;AACJ;AACA;AACA;AACA;AACA;;;AAGI;AACU,YAANK,MAAM,GAAM;AACZ,iBAAO,KAAKN,aAAL,CAAmB,CAAnB,CAAP;AACH;;AAKDO,QAAAA,WAAW,CAACC,OAAD,EAAwB;AAjCnC;AAiCmC,eAhC3BA,OAgC2B;AAAA,eA9B3BJ,cA8B2B,GA9BM,IAAIK,GAAJ,EA8BN;AAAA,eA5B3BR,cA4B2B,GA5BE,IA4BF;AAAA,eAVnCS,KAUmC,GAV3B,CAU2B;AAAA,eAH3BC,gBAG2B,GAHe,IAGf;AAAA,eAF3BC,gBAE2B,GAFe,IAEf;AAC/B,eAAKJ,OAAL,GAAeA,OAAf;AACH;;AAEDK,QAAAA,sBAAsB,CAACP,MAAD,EAAY;AAC9B,cAAI,KAAKE,OAAL,CAAaM,OAAb,CAAqBR,MAArB,CAAJ,EAAkC;AAA0B;AACxD,iBAAKF,cAAL,CAAoBW,GAApB,CAAwBT,MAAM,CAACU,GAA/B,EAAoCV,MAApC;;AACA,iBAAKL,cAAL,GAAsB,IAAtB;AACA,iBAAKS,KAAL;;AAEA,gBAAI,KAAKC,gBAAT,EAA2B;AACvB,mBAAKA,gBAAL,CAAsBI,GAAtB,CAA0BT,MAAM,CAACU,GAAjC,EAAsCV,MAAtC;;AACA,mBAAKM,gBAAL,CAAuBK,MAAvB,CAA8BX,MAAM,CAACU,GAArC;AACH;AACJ,WATD,MAUK,IAAI,KAAKZ,cAAL,CAAoBc,GAApB,CAAwBZ,MAAM,CAACU,GAA/B,CAAJ,EAAyC;AAAc;AACxD,iBAAKZ,cAAL,CAAoBa,MAApB,CAA2BX,MAAM,CAACU,GAAlC;;AACA,iBAAKf,cAAL,GAAsB,IAAtB;AACA,iBAAKS,KAAL;;AAEA,gBAAI,KAAKC,gBAAT,EAA2B;AACvB,mBAAKA,gBAAL,CAAsBM,MAAtB,CAA6BX,MAAM,CAACU,GAApC;;AACA,mBAAKJ,gBAAL,CAAuBG,GAAvB,CAA2BT,MAAM,CAACU,GAAlC,EAAuCV,MAAvC;AACH;AACJ;AACJ;;AAEDa,QAAAA,yBAAyB,CAACC,eAAD,EAAkCC,eAAlC,EAAmE;AACxF,eAAKV,gBAAL,GAAwBS,eAAxB;AACA,eAAKR,gBAAL,GAAwBS,eAAxB;AACH;;AAEDC,QAAAA,KAAK,GAAG;AAAA;;AACJ,eAAKlB,cAAL,CAAoBkB,KAApB;;AACA,eAAKrB,cAAL,GAAsB,IAAtB;AACA,eAAKS,KAAL,GAAa,CAAb;AACA,wCAAKC,gBAAL,mCAAuBW,KAAvB;AACA,wCAAKV,gBAAL,mCAAuBU,KAAvB;AACH;;AAxEkD,O","sourcesContent":["/*\r\n * @Author: dgflash\r\n * @Date: 2022-09-01 18:00:28\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2022-09-05 14:21:54\r\n */\r\nimport { ecs } from \"./ECS\";\r\nimport { ECSEntity } from \"./ECSEntity\";\r\n\r\nexport class ECSGroup<E extends ECSEntity = ECSEntity> {\r\n    /** 实体筛选规则 */\r\n    private matcher: ecs.IMatcher;\r\n\r\n    private _matchEntities: Map<number, E> = new Map();\r\n\r\n    private _entitiesCache: E[] | null = null;\r\n\r\n    /**\r\n     * 符合规则的实体\r\n     */\r\n    get matchEntities() {\r\n        if (this._entitiesCache === null) {\r\n            this._entitiesCache = Array.from(this._matchEntities.values());\r\n        }\r\n        return this._entitiesCache;\r\n    }\r\n\r\n    /**\r\n     * 当前group中实体的数量\r\n     * \r\n     * 注：不要手动修改这个属性值。\r\n     * 注：其实可以通过this._matchEntities.size获得实体数量，但是需要封装get方法。为了减少一次方法的调用所以才直接创建一个count属性\r\n     */\r\n    count = 0;\r\n\r\n    /** 获取matchEntities中第一个实体 */\r\n    get entity(): E {\r\n        return this.matchEntities[0];\r\n    }\r\n\r\n    private _enteredEntities: Map<number, E> | null = null;\r\n    private _removedEntities: Map<number, E> | null = null;\r\n\r\n    constructor(matcher: ecs.IMatcher) {\r\n        this.matcher = matcher;\r\n    }\r\n\r\n    onComponentAddOrRemove(entity: E) {\r\n        if (this.matcher.isMatch(entity)) {                         // Group只关心指定组件在实体身上的添加和删除动作。\r\n            this._matchEntities.set(entity.eid, entity);\r\n            this._entitiesCache = null;\r\n            this.count++;\r\n\r\n            if (this._enteredEntities) {\r\n                this._enteredEntities.set(entity.eid, entity);\r\n                this._removedEntities!.delete(entity.eid);\r\n            }\r\n        }\r\n        else if (this._matchEntities.has(entity.eid)) {             // 如果Group中有这个实体，但是这个实体已经不满足匹配规则，则从Group中移除该实体\r\n            this._matchEntities.delete(entity.eid);\r\n            this._entitiesCache = null;\r\n            this.count--;\r\n\r\n            if (this._enteredEntities) {\r\n                this._enteredEntities.delete(entity.eid);\r\n                this._removedEntities!.set(entity.eid, entity);\r\n            }\r\n        }\r\n    }\r\n\r\n    watchEntityEnterAndRemove(enteredEntities: Map<number, E>, removedEntities: Map<number, E>) {\r\n        this._enteredEntities = enteredEntities;\r\n        this._removedEntities = removedEntities;\r\n    }\r\n\r\n    clear() {\r\n        this._matchEntities.clear();\r\n        this._entitiesCache = null;\r\n        this.count = 0;\r\n        this._enteredEntities?.clear();\r\n        this._removedEntities?.clear();\r\n    }\r\n}"]}