{"version":3,"sources":["file:///Volumes/SSD%201/ccProject/extensions/oops-plugin-framework/assets/libs/ecs/ECSModel.ts"],"names":["ECSModel","ECSGroup","createGroup","matcher","group","groups","get","mid","set","careComponentTypeIds","indices","i","length","compAddOrRemove","push","onComponentAddOrRemove","bind","eid","entityCtors","Map","entityPool","eid2Entity","compTid","compPools","compCtors","tid2comp","systems"],"mappings":";;;wCA8BaA,Q;;;;;;;;;;;;;;;;;;;;;;AAtBJC,MAAAA,Q,iBAAAA,Q;;;;;;AART;AACA;AACA;AACA;AACA;AACA;;;AAOA;;AAGA;;AAKA;;AASA;0BACaD,Q,GAAN,MAAMA,QAAN,CAAe;AAgClB;AACJ;AACA;AACA;AACsB,eAAXE,WAAW,CAAkCC,OAAlC,EAAsE;AACpF,cAAIC,KAAK,GAAGJ,QAAQ,CAACK,MAAT,CAAgBC,GAAhB,CAAoBH,OAAO,CAACI,GAA5B,CAAZ;;AACA,cAAI,CAACH,KAAL,EAAY;AACRA,YAAAA,KAAK,GAAG;AAAA;AAAA,sCAAaD,OAAb,CAAR;AACAH,YAAAA,QAAQ,CAACK,MAAT,CAAgBG,GAAhB,CAAoBL,OAAO,CAACI,GAA5B,EAAiCH,KAAjC;AACA,gBAAIK,oBAAoB,GAAGN,OAAO,CAACO,OAAnC;;AACA,iBAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGF,oBAAoB,CAACG,MAAzC,EAAiDD,CAAC,EAAlD,EAAsD;AAClDX,cAAAA,QAAQ,CAACa,eAAT,CAAyBP,GAAzB,CAA6BG,oBAAoB,CAACE,CAAD,CAAjD,EAAuDG,IAAvD,CAA4DV,KAAK,CAACW,sBAAN,CAA6BC,IAA7B,CAAkCZ,KAAlC,CAA5D;AACH;AACJ;;AACD,iBAAOA,KAAP;AACH;AAED;;;AAjDkB,O;;AAClB;AADSJ,MAAAA,Q,CAEFiB,G,GAAM,C;;AACb;AAHSjB,MAAAA,Q,CAIFkB,W,GAA4C,IAAIC,GAAJ,E;;AACnD;AALSnB,MAAAA,Q,CAMFoB,U,GAAuC,IAAID,GAAJ,E;;AAC9C;AAPSnB,MAAAA,Q,CAQFqB,U,GAAqC,IAAIF,GAAJ,E;;AAE5C;AAVSnB,MAAAA,Q,CAWFsB,O,GAAU,C;;AACjB;AAZStB,MAAAA,Q,CAaFuB,S,GAAsC,IAAIJ,GAAJ,E;;AAC7C;AAdSnB,MAAAA,Q,CAeFwB,S,GAAwC,E;;AAC/C;AACJ;AACA;AACA;AAnBaxB,MAAAA,Q,CAoBFa,e,GAAkD,IAAIM,GAAJ,E;;AAEzD;AAtBSnB,MAAAA,Q,CAuBFyB,Q,GAAmC,IAAIN,GAAJ,E;;AAE1C;AACJ;AACA;AACA;AACA;AA7BanB,MAAAA,Q,CA8BFK,M,GAAgC,IAAIc,GAAJ,E;AA9B9BnB,MAAAA,Q,CAkDF0B,O,GAAmC,IAAIP,GAAJ,E","sourcesContent":["/*\r\n * @Author: dgflash\r\n * @Date: 2022-05-12 14:18:44\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2022-09-05 16:37:10\r\n */\r\nimport { ecs } from \"./ECS\";\r\nimport { ECSEntity } from \"./ECSEntity\";\r\nimport { ECSGroup } from \"./ECSGroup\";\r\n\r\ntype CompAddOrRemove = (entity: ecs.Entity) => void;\r\n\r\n/** 组件类型 */\r\nexport type CompType<T> = CompCtor<T> | number;\r\n\r\n/** 实体构造器接口 */\r\nexport interface EntityCtor<T> {\r\n    new(): T;\r\n}\r\n\r\n/** 组件构造器接口 */\r\nexport interface CompCtor<T> {\r\n    new(): T;\r\n    /** 组件编号 */\r\n    tid: number;\r\n    /** 组件名 */\r\n    compName: string;\r\n}\r\n\r\n/** ECS框架内部数据 */\r\nexport class ECSModel {\r\n    /** 实体自增id */\r\n    static eid = 1;\r\n    /** 实体造函数 */\r\n    static entityCtors: Map<EntityCtor<any>, string> = new Map();\r\n    /** 实体对象缓存池 */\r\n    static entityPool: Map<string, ECSEntity[]> = new Map();\r\n    /** 通过实体id查找实体对象 */\r\n    static eid2Entity: Map<number, ECSEntity> = new Map();\r\n\r\n    /** 组件类型id */\r\n    static compTid = 0;\r\n    /** 组件缓存池 */\r\n    static compPools: Map<number, ecs.IComp[]> = new Map();\r\n    /** 组件构造函数 */\r\n    static compCtors: (CompCtor<any> | number)[] = [];\r\n    /**\r\n     * 每个组件的添加和删除的动作都要派送到“关心”它们的group上。goup对当前拥有或者之前（删除前）拥有该组件的实体进行组件规则判断。判断该实体是否满足group\r\n     * 所期望的组件组合。\r\n     */\r\n    static compAddOrRemove: Map<number, CompAddOrRemove[]> = new Map();\r\n\r\n    /** 编号获取组件 */\r\n    static tid2comp: Map<number, ecs.IComp> = new Map();\r\n\r\n    /**\r\n     * 缓存的group\r\n     * \r\n     * key是组件的筛选规则，一个筛选规则对应一个group\r\n     */\r\n    static groups: Map<number, ECSGroup> = new Map();\r\n\r\n    /**\r\n     * 创建group，每个group只关心对应组件的添加和删除\r\n     * @param matcher 实体筛选器\r\n     */\r\n    static createGroup<E extends ECSEntity = ECSEntity>(matcher: ecs.IMatcher): ECSGroup<E> {\r\n        let group = ECSModel.groups.get(matcher.mid);\r\n        if (!group) {\r\n            group = new ECSGroup(matcher);\r\n            ECSModel.groups.set(matcher.mid, group);\r\n            let careComponentTypeIds = matcher.indices;\r\n            for (let i = 0; i < careComponentTypeIds.length; i++) {\r\n                ECSModel.compAddOrRemove.get(careComponentTypeIds[i])!.push(group.onComponentAddOrRemove.bind(group));\r\n            }\r\n        }\r\n        return group as unknown as ECSGroup<E>;\r\n    }\r\n\r\n    /** 系统组件 */\r\n    static systems: Map<string, ecs.System> = new Map<string, ecs.System>();\r\n}"]}