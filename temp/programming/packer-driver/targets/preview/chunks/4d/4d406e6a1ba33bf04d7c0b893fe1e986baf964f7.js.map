{"version":3,"sources":["file:///Volumes/SSD/ccProject/extensions/oops-plugin-framework/assets/core/common/storage/StorageManager.ts"],"names":["StorageManager","sys","PREVIEW","EncryptUtil","_key","_iv","_id","init","key","iv","initCrypto","md5","setUser","id","set","value","keywords","console","error","warn","remove","JSON","stringify","e","aesEncrypt","localStorage","setItem","get","defaultValue","str","getItem","aesDecrypt","getNumber","r","Number","getBoolean","Boolean","getJson","parse","removeItem","clear"],"mappings":"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","sourcesContent":["import { sys } from \"cc\";\r\nimport { PREVIEW } from \"cc/env\";\r\nimport { EncryptUtil } from \"../../utils/EncryptUtil\";\r\n\r\n/** 本地存储 */\r\nexport class StorageManager {\r\n    private _key: string | null = null;\r\n    private _iv: string | null = null;\r\n    private _id: string = \"\";\r\n\r\n    /**\r\n     * 初始化密钥\r\n     * @param key aes加密的key \r\n     * @param iv  aes加密的iv\r\n     */\r\n    init(key: string, iv: string) {\r\n        EncryptUtil.initCrypto(key, iv);\r\n\r\n        this._key = EncryptUtil.md5(key);\r\n        this._iv = EncryptUtil.md5(iv);\r\n    }\r\n\r\n    /**\r\n     * 设置用户唯一标识\r\n     * @param id \r\n     */\r\n    setUser(id: string) {\r\n        this._id = id;\r\n    }\r\n\r\n    /**\r\n     * 存储本地数据\r\n     * @param key 存储key\r\n     * @param value 存储值\r\n     * @returns \r\n     */\r\n    set(key: string, value: any) {\r\n        var keywords = `${key}_${this._id}`;\r\n\r\n        if (null == key) {\r\n            console.error(\"存储的key不能为空\");\r\n            return;\r\n        }\r\n        if (!PREVIEW) {\r\n            keywords = EncryptUtil.md5(keywords);\r\n        }\r\n        if (null == value) {\r\n            console.warn(\"存储的值为空，则直接移除该存储\");\r\n            this.remove(key);\r\n            return;\r\n        }\r\n        if (typeof value === 'function') {\r\n            console.error(\"储存的值不能为方法\");\r\n            return;\r\n        }\r\n        if (typeof value === 'object') {\r\n            try {\r\n                value = JSON.stringify(value);\r\n            }\r\n            catch (e) {\r\n                console.error(`解析失败，str = ${value}`);\r\n                return;\r\n            }\r\n        }\r\n        else if (typeof value === 'number') {\r\n            value = value + \"\";\r\n        }\r\n\r\n        if (!PREVIEW && null != this._key && null != this._iv) {\r\n            value = EncryptUtil.aesEncrypt(`${value}`, this._key, this._iv);\r\n        }\r\n        sys.localStorage.setItem(keywords, value);\r\n    }\r\n\r\n    /**\r\n     * 获取指定关键字的数据\r\n     * @param key          获取的关键字\r\n     * @param defaultValue 获取的默认值\r\n     * @returns \r\n     */\r\n    get(key: string, defaultValue: any = \"\"): string {\r\n        if (null == key) {\r\n            console.error(\"存储的key不能为空\");\r\n            return null!;\r\n        }\r\n\r\n        key = `${key}_${this._id}`;\r\n\r\n        if (!PREVIEW) {\r\n            key = EncryptUtil.md5(key);\r\n        }\r\n\r\n        let str: string | null = sys.localStorage.getItem(key);\r\n        if (null != str && '' !== str && !PREVIEW && null != this._key && null != this._iv) {\r\n            str = EncryptUtil.aesDecrypt(str, this._key, this._iv);\r\n        }\r\n\r\n        if (null === str) {\r\n            return defaultValue;\r\n        }\r\n        return str;\r\n    }\r\n\r\n    /** 获取指定关键字的数值 */\r\n    getNumber(key: string, defaultValue: number = 0): number {\r\n        var r = this.get(key);\r\n        if (r == \"0\") {\r\n            return Number(r);\r\n        }\r\n        return Number(r) || defaultValue;\r\n    }\r\n\r\n    /** 获取指定关键字的布尔值 */\r\n    getBoolean(key: string): boolean {\r\n        var r = this.get(key);\r\n        return Boolean(r) || false;\r\n    }\r\n\r\n    /** 获取指定关键字的JSON对象 */\r\n    getJson(key: string, defaultValue?: any): any {\r\n        var r = this.get(key);\r\n        return (r && JSON.parse(r)) || defaultValue;\r\n    }\r\n\r\n    /**\r\n     * 删除指定关键字的数据\r\n     * @param key 需要移除的关键字\r\n     * @returns \r\n     */\r\n    remove(key: string) {\r\n        if (null == key) {\r\n            console.error(\"存储的key不能为空\");\r\n            return;\r\n        }\r\n\r\n        var keywords = `${key}_${this._id}`;\r\n\r\n        if (!PREVIEW) {\r\n            keywords = EncryptUtil.md5(keywords);\r\n        }\r\n        sys.localStorage.removeItem(keywords);\r\n    }\r\n\r\n    /** 清空整个本地存储 */\r\n    clear() {\r\n        sys.localStorage.clear();\r\n    }\r\n}"]}