{"version":3,"sources":["file:///Volumes/%E5%9B%BA%E6%80%81/project/extensions/oops-plugin-framework/assets/core/Root.ts"],"names":["Component","Game","JsonAsset","Node","_decorator","director","game","screen","sys","LanguageManager","BuildTimeConstants","GameConfig","GameQueryConfig","oops","version","AudioManager","EventMessage","TimerManager","GameManager","GUI","LayerManager","ccclass","property","isInited","Root","type","tooltip","persistRootNode","onLoad","console","log","enabled","config_name","res","load","config","get","btc","query","http","server","httpServer","timeout","httpTimeout","storage","init","localDataKey","localDataIv","frameRate","run","update","dt","ecs","execute","initGui","initEcsSystem","addPersistRootNode","audio","addComponent","timer","language","gui","on","EVENT_SHOW","logView","resumeAll","resume","message","dispatchEvent","GAME_ENTER","EVENT_HIDE","save","pauseAll","pause","GAME_EXIT","c_gui","isMobile","resize","GAME_RESIZE"],"mappings":"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","sourcesContent":["/*\r\n * @Author: dgflash\r\n * @Date: 2021-07-03 16:13:17\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2023-08-28 10:02:57\r\n */\r\nimport { Component, Game, JsonAsset, Node, _decorator, director, game, screen, sys } from \"cc\";\r\nimport { LanguageManager } from \"../libs/gui/language/Language\";\r\nimport { BuildTimeConstants } from \"../module/config/BuildTimeConstants\";\r\nimport { GameConfig } from \"../module/config/GameConfig\";\r\nimport { GameQueryConfig } from \"../module/config/GameQueryConfig\";\r\nimport { oops, version } from \"./Oops\";\r\nimport { AudioManager } from \"./common/audio/AudioManager\";\r\nimport { EventMessage } from \"./common/event/EventMessage\";\r\nimport { TimerManager } from \"./common/timer/TimerManager\";\r\nimport { GameManager } from \"./game/GameManager\";\r\nimport { GUI } from \"./gui/GUI\";\r\nimport { LayerManager } from \"./gui/layer/LayerManager\";\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\nvar isInited = false;\r\n\r\n/** 框架显示层根节点 */\r\nexport class Root extends Component {\r\n    /** 游戏层节点 */\r\n    @property({\r\n        type: Node,\r\n        tooltip: \"游戏层\"\r\n    })\r\n    game: Node = null!;\r\n\r\n    /** 界面层节点 */\r\n    @property({\r\n        type: Node,\r\n        tooltip: \"界面层\"\r\n    })\r\n    gui: Node = null!;\r\n\r\n    /** 持久根节点 */\r\n    persistRootNode: Node = null!\r\n\r\n    onLoad() {\r\n        if (!isInited) {\r\n            isInited = true;      // 注：这里是规避cc3.8在编辑器模式下运行时，关闭游戏会两次初始化报错\r\n\r\n            console.log(`Oops Framework v${version}`);\r\n            this.enabled = false;\r\n\r\n            let config_name = \"config\";\r\n            oops.res.load(config_name, JsonAsset, () => {\r\n                var config = oops.res.get(config_name);\r\n                oops.config.btc = new BuildTimeConstants();\r\n                oops.config.query = new GameQueryConfig();\r\n                oops.config.game = new GameConfig(config);\r\n                oops.http.server = oops.config.game.httpServer;                                      // Http 服务器地址\r\n                oops.http.timeout = oops.config.game.httpTimeout;                                    // Http 请求超时时间\r\n                oops.storage.init(oops.config.game.localDataKey, oops.config.game.localDataIv);      // 初始化本地存储加密\r\n                game.frameRate = oops.config.game.frameRate;                                         // 初始化每秒传输帧数\r\n\r\n                this.enabled = true;\r\n                this.init();\r\n                this.run();\r\n            });\r\n        }\r\n    }\r\n\r\n    update(dt: number) {\r\n        oops.ecs.execute(dt);\r\n    }\r\n\r\n    /** 初始化游戏界面 */\r\n    protected initGui() {\r\n\r\n    }\r\n\r\n    /** 初始化游戏业务模块 */\r\n    protected initEcsSystem() {\r\n\r\n    }\r\n\r\n    /** 加载完引擎配置文件后执行 */\r\n    protected run() {\r\n\r\n    }\r\n\r\n    protected init() {\r\n        // 创建持久根节点\r\n        this.persistRootNode = new Node(\"PersistRootNode\");\r\n        director.addPersistRootNode(this.persistRootNode);\r\n\r\n        // 创建音频模块\r\n        oops.audio = this.persistRootNode.addComponent(AudioManager);\r\n        oops.audio.load();\r\n\r\n        // 创建时间模块\r\n        oops.timer = this.persistRootNode.addComponent(TimerManager)!;\r\n\r\n        oops.language = new LanguageManager();\r\n        oops.game = new GameManager(this.game);\r\n        oops.gui = new LayerManager(this.gui);\r\n        this.initGui();\r\n        this.initEcsSystem();\r\n        oops.ecs.init();\r\n\r\n        // 游戏显示事件\r\n        game.on(Game.EVENT_SHOW, () => {\r\n            oops.log.logView(\"【系统】游戏前台显示\");\r\n            oops.timer.load();     // 平台不需要在退出时精准计算时间，直接暂时游戏时间\r\n            oops.audio.resumeAll();\r\n            director.resume();\r\n            game.resume();\r\n            oops.message.dispatchEvent(EventMessage.GAME_ENTER);\r\n        });\r\n\r\n        // 游戏隐藏事件\r\n        game.on(Game.EVENT_HIDE, () => {\r\n            oops.log.logView(\"【系统】游戏切到后台\");\r\n            oops.timer.save();     // 平台不需要在退出时精准计算时间，直接暂时游戏时间\r\n            oops.audio.pauseAll();\r\n            director.pause();\r\n            game.pause();\r\n            oops.message.dispatchEvent(EventMessage.GAME_EXIT);\r\n        });\r\n\r\n        // 游戏尺寸修改事件\r\n        var c_gui = this.gui.addComponent(GUI)!;\r\n        if (sys.isMobile == false) {\r\n            screen.on(\"window-resize\", () => {\r\n                oops.log.logView(\"【系统】游戏画布尺寸变化\");\r\n                c_gui.resize();\r\n                oops.message.dispatchEvent(EventMessage.GAME_RESIZE);\r\n            }, this);\r\n\r\n            screen.on(\"fullscreen-change\", () => {\r\n                oops.log.logView(\"【系统】游戏全屏显示\");\r\n            }, this);\r\n        }\r\n\r\n        screen.on(\"orientation-change\", () => {\r\n            oops.log.logView(\"【系统】游戏旋转屏幕\");\r\n        }, this);\r\n    }\r\n}"]}