{"version":3,"sources":["file:///Volumes/SSD/ccProject/extensions/oops-plugin-framework/assets/libs/animator-effect/3d/NavLine.ts"],"names":["Color","Component","macro","MeshRenderer","Node","v2","Vec2","Vec3","_decorator","ccclass","property","NavLine","type","displayName","tooltip","min","mat","inited","distance","frame","start_pos","target_pos","tOffset","start","mesh","material","setProperty","speed","hide","show","pos","node","setRotationFromEuler","player","eulerAngles","y","active","color","set","worldPosition","setDistance","setScale","scale","x","setWorldPosition","density","xEuler","rotation","end","angle","Math","asin","sin","abs","DEG","update","dt","interval"],"mappings":";;;;;;;;;;;;;;;;AAOSA,MAAAA,K,OAAAA,K;AAAOC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,K,OAAAA,K;AAAOC,MAAAA,Y,OAAAA,Y;AAAcC,MAAAA,I,OAAAA,I;AAAgBC,MAAAA,E,OAAAA,E;AAAIC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,U,OAAAA,U;;;;;;AAPhF;AACA;AACA;AACA;AACA;AACA;;;;;OAGM;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBF,U;;yBAGjBG,O,WADZF,OAAO,CAAC,iBAAD,C,UAEHC,QAAQ,CAAC;AAAEE,QAAAA,IAAI,EAAER,IAAR;AAAcS,QAAAA,WAAW,EAAE;AAA3B,OAAD,C,UAGRH,QAAQ,CAAC;AAAEE,QAAAA,IAAI,EAAET,YAAR;AAAsBU,QAAAA,WAAW,EAAE,MAAnC;AAA2CC,QAAAA,OAAO,EAAE;AAApD,OAAD,C,UAGRJ,QAAQ,CAAC;AAAEG,QAAAA,WAAW,EAAE;AAAf,OAAD,C,UAGRH,QAAQ,CAAC;AAAEG,QAAAA,WAAW,EAAE,MAAf;AAAuBC,QAAAA,OAAO,EAAE,yBAAhC;AAA2DC,QAAAA,GAAG,EAAE;AAAhE,OAAD,C,UAGRL,QAAQ,CAAC;AAAEG,QAAAA,WAAW,EAAE,MAAf;AAAuBC,QAAAA,OAAO,EAAE,0BAAhC;AAA4DC,QAAAA,GAAG,EAAE;AAAjE,OAAD,C,UAGRL,QAAQ,CAAC;AAAEG,QAAAA,WAAW,EAAE,MAAf;AAAuBC,QAAAA,OAAO,EAAE,gBAAhC;AAAkDC,QAAAA,GAAG,EAAE;AAAvD,OAAD,C,UAGRL,QAAQ,CAAC;AAAEG,QAAAA,WAAW,EAAE,MAAf;AAAuBC,QAAAA,OAAO,EAAE;AAAhC,OAAD,C,2BApBb,MACaH,OADb,SAC6BV,SAD7B,CACuC;AAAA;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAsBnC;AAtBmC,eAuB3Be,GAvB2B,GAuBM,IAvBN;;AAyBnC;AAzBmC,eA0B3BC,MA1B2B,GA0BlB,KA1BkB;AAAA,eA4B3BC,QA5B2B,GA4BR,CA5BQ;AAAA,eA6B3BC,KA7B2B,GA6BX,CA7BW;AAAA,eA8B3BC,SA9B2B,GA8Bf,IAAIb,IAAJ,EA9Be;AAAA,eA+B3Bc,UA/B2B,GA+Bd,IAAId,IAAJ,EA/Bc;AAAA,eAgC3Be,OAhC2B,GAgCjB,IAAIhB,IAAJ,CAAS,CAAT,EAAY,CAAZ,CAhCiB;AAAA;;AAkCnCiB,QAAAA,KAAK,GAAG;AACJ,eAAKP,GAAL,GAAW,KAAKQ,IAAL,CAAUC,QAArB;AACA,eAAKT,GAAL,CAASU,WAAT,CAAqB,kBAArB,EAAyCrB,EAAE,CAAC,CAAD,EAAI,KAAKsB,KAAT,CAA3C,EAFI,CAE8D;;AAClE,eAAKC,IAAL;AACH;AAED;;;AACAC,QAAAA,IAAI,CAACC,GAAD,EAAY;AACZ,eAAKC,IAAL,CAAUC,oBAAV,CAA+B,CAA/B,EAAkC,KAAKC,MAAL,CAAYC,WAAZ,CAAwBC,CAA1D,EAA6D,CAA7D;AAEA,eAAKX,IAAL,CAAUO,IAAV,CAAeK,MAAf,GAAwB,IAAxB;AACA,eAAKjB,KAAL,GAAa,CAAb;AACA,eAAKF,MAAL,GAAc,IAAd;AACA,eAAKD,GAAL,CAASU,WAAT,CAAqB,WAArB,EAAkC,KAAKW,KAAvC;AAEA,eAAKjB,SAAL,CAAekB,GAAf,CAAmB,KAAKL,MAAL,CAAYM,aAA/B;AACA,eAAKlB,UAAL,CAAgBiB,GAAhB,CAAoBR,GAApB;AACA,eAAKU,WAAL;AACH;AAED;;;AACAZ,QAAAA,IAAI,GAAG;AACH,eAAKX,MAAL,GAAc,KAAd;AACA,eAAKO,IAAL,CAAUO,IAAV,CAAeK,MAAf,GAAwB,KAAxB;AACH;AAED;;;AACQI,QAAAA,WAAW,GAAG;AAClB;AACA,eAAKtB,QAAL,GAAgBX,IAAI,CAACW,QAAL,CAAc,KAAKG,UAAnB,EAA+B,KAAKY,MAAL,CAAYM,aAA3C,CAAhB;AACA,eAAKR,IAAL,CAAUU,QAAV,CAAmB,KAAKV,IAAL,CAAUW,KAAV,CAAgBC,CAAnC,EAAsC,KAAKZ,IAAL,CAAUW,KAAV,CAAgBP,CAAtD,EAAyD,KAAKjB,QAA9D;AACA,eAAKa,IAAL,CAAUa,gBAAV,CAA2B,KAAKX,MAAL,CAAYM,aAAvC;AACA,eAAKjB,OAAL,CAAaa,CAAb,GAAiB,KAAKjB,QAAL,GAAgB,KAAK2B,OAAtC;AACA,eAAK7B,GAAL,CAASU,WAAT,CAAqB,cAArB,EAAqC,KAAKJ,OAA1C;AAEA,cAAI,KAAKwB,MAAT,EAAiB,KAAKC,QAAL,CAAc,KAAK3B,SAAnB,EAA8B,KAAKC,UAAnC;AACpB;AAED;;;AACQ0B,QAAAA,QAAQ,CAACxB,KAAD,EAAcyB,GAAd,EAAyB;AACrC;AACA,cAAIC,KAAK,GAAGC,IAAI,CAACC,IAAL,CAAUD,IAAI,CAACE,GAAL,CAASF,IAAI,CAACG,GAAL,CAASL,GAAG,CAACb,CAAJ,GAAQZ,KAAK,CAACY,CAAvB,IAA4B,KAAKjB,QAA1C,CAAV,IAAiEhB,KAAK,CAACoD,GAAvE,GAA6E,GAAzF;AACA,cAAIX,CAAC,GAAIK,GAAG,CAACb,CAAJ,GAAQZ,KAAK,CAACY,CAAf,GAAoB,CAApB,GAAwB,CAACc,KAAzB,GAAiCA,KAAzC;AACA,eAAKlB,IAAL,CAAUC,oBAAV,CAA+BW,CAA/B,EAAkC,KAAKV,MAAL,CAAYC,WAAZ,CAAwBC,CAA1D,EAA6D,CAA7D;AACH;;AAEDoB,QAAAA,MAAM,CAACC,EAAD,EAAa;AACf,cAAI,KAAKvC,MAAT,EAAiB;AACb,iBAAKE,KAAL;;AACA,gBAAI,KAAKA,KAAL,IAAc,KAAKsC,QAAvB,EAAiC;AAC7B,mBAAKjB,WAAL;AACA,mBAAKrB,KAAL,GAAa,CAAb;AACH;AACJ;AACJ;;AAxFkC,O;;;;;iBAEpB,I;;;;;;;iBAGM,I;;;;;;;iBAGN,IAAInB,KAAJ,CAAU,GAAV,EAAe,CAAf,EAAkB,CAAlB,EAAqB,GAArB,C;;;;;;;iBAGJ,C;;;;;;;iBAGH,C;;;;;;;iBAGE,C;;;;;;;iBAGD,I","sourcesContent":["/*\r\n * @Author: dgflash\r\n * @Date: 2022-03-25 10:53:30\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2022-03-25 23:43:25\r\n */\r\n\r\nimport { Color, Component, macro, MeshRenderer, Node, renderer, v2, Vec2, Vec3, _decorator } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('NavLine - 导航钱组件')\r\nexport class NavLine extends Component {\r\n    @property({ type: Node, displayName: \"玩家模型节点\" })\r\n    player: Node = null!;\r\n\r\n    @property({ type: MeshRenderer, displayName: \"箭头网格\", tooltip: \"拖MeshRenderer组件到这里\" })\r\n    mesh: MeshRenderer = null!;\r\n\r\n    @property({ displayName: \"导航线颜色\" })\r\n    color: Color = new Color(255, 0, 0, 255);\r\n\r\n    @property({ displayName: \"执行间隔\", tooltip: \"多少帧执行一次，数值越大动画越流程，建议3-5\", min: 1 })\r\n    interval = 5;\r\n\r\n    @property({ displayName: \"箭头速度\", tooltip: \"控制材质texture位移，数值越大动画播放越快\", min: 0.1 })\r\n    speed = 2;\r\n\r\n    @property({ displayName: \"箭头密度\", tooltip: \"控制箭头的密度，数值越大越密\", min: 0.1 })\r\n    density = 1;\r\n\r\n    @property({ displayName: \"角度变化\", tooltip: \"箭头是否有 x 欧拉角度变化，有高度的地形引导开启\" })\r\n    xEuler = true;\r\n\r\n    /* 材质 */\r\n    private mat: renderer.MaterialInstance = null!;\r\n\r\n    /* 导航线是否启动 */\r\n    private inited = false;\r\n\r\n    private distance: number = 0;\r\n    private frame: number = 0;\r\n    private start_pos = new Vec3();\r\n    private target_pos = new Vec3();\r\n    private tOffset = new Vec2(1, 1);\r\n\r\n    start() {\r\n        this.mat = this.mesh.material!;\r\n        this.mat.setProperty(\"textureMoveSpeed\", v2(0, this.speed));      // 根据需求也可以是 x 轴，动画移动\r\n        this.hide();\r\n    }\r\n\r\n    /** 开始提示 */\r\n    show(pos: Vec3) {\r\n        this.node.setRotationFromEuler(0, this.player.eulerAngles.y, 0);\r\n\r\n        this.mesh.node.active = true;\r\n        this.frame = 0;\r\n        this.inited = true;\r\n        this.mat.setProperty(\"mainColor\", this.color);\r\n\r\n        this.start_pos.set(this.player.worldPosition);\r\n        this.target_pos.set(pos);\r\n        this.setDistance();\r\n    }\r\n\r\n    /** 结束提示 */\r\n    hide() {\r\n        this.inited = false;\r\n        this.mesh.node.active = false;\r\n    }\r\n\r\n    /** 距离实时计算 */\r\n    private setDistance() {\r\n        // 目标与\r\n        this.distance = Vec3.distance(this.target_pos, this.player.worldPosition);\r\n        this.node.setScale(this.node.scale.x, this.node.scale.y, this.distance);\r\n        this.node.setWorldPosition(this.player.worldPosition);\r\n        this.tOffset.y = this.distance * this.density;\r\n        this.mat.setProperty(\"tilingOffset\", this.tOffset);\r\n\r\n        if (this.xEuler) this.rotation(this.start_pos, this.target_pos);\r\n    }\r\n\r\n    /** 旋转朝向 */\r\n    private rotation(start: Vec3, end: Vec3) {\r\n        // 角色转动的角度, 相对Z轴，逆时针为正方向\r\n        var angle = Math.asin(Math.sin(Math.abs(end.y - start.y) / this.distance)) * macro.DEG % 360;\r\n        var x = (end.y - start.y) > 0 ? -angle : angle;\r\n        this.node.setRotationFromEuler(x, this.player.eulerAngles.y, 0);\r\n    }\r\n\r\n    update(dt: number) {\r\n        if (this.inited) {\r\n            this.frame++;\r\n            if (this.frame >= this.interval) {\r\n                this.setDistance()\r\n                this.frame = 0;\r\n            }\r\n        }\r\n    }\r\n}"]}